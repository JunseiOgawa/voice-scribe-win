# VoiceScribe - 要件定義書

**作成日**: 2026-02-02
**バージョン**: 1.0

## 1. プロジェクト概要

### 1.1 プロジェクト名
- **表示名**: VoiceScribe
- **リポジトリ名**: voice-scribe-win
- **説明**: Windows向け高精度ローカル音声文字起こしアプリケーション

### 1.2 目的
既存のWindows音声認識アプリの問題点を解決する：
- 日本語文字起こしの精度向上
- 変換速度の改善
- 柔軟な操作性（フォーカス制御、キーボード操作対応）
- 完全ローカル処理（オフライン動作）

### 1.3 対象ユーザー
- 日本語音声の高精度文字起こしが必要なビジネスユーザー
- オフライン環境で音声認識が必要な環境
- プライバシーを重視するユーザー

## 2. 技術スタック

### 2.1 フレームワーク・言語
- **UI**: WinUI 3（Windows App SDK 1.5+）
- **言語**: C# 12
- **.NET**: .NET 8 LTS
- **アーキテクチャ**: MVVM（CommunityToolkit.Mvvm使用）

### 2.2 音声認識エンジン
- **メインエンジン**: ReazonSpeech-NeMo v2
  - 高速モデル: 日常的なメモ取り用（~500ms）
  - 高精度モデル: 議事録など正確性が求められる用途

### 2.3 主要ライブラリ
| 用途 | ライブラリ | 用途詳細 |
|------|-----------|---------|
| 音声入力 | NAudio | マイク入力制御・バッファリング |
| MVVM | CommunityToolkit.Mvvm | ViewModel実装 |
| キーボード入力 | Windows Input Simulator | テキスト入力シミュレーション |
| システムトレイ | H.NotifyIcon.WinUI | システムトレイアイコン |
| ホットキー | GlobalHotKey / Win32 API | グローバルホットキー登録 |
| 推論エンジン | ONNX Runtime / Python interop | 音声モデル実行 |

## 3. 要件定義

### 3.1 機能要件

#### Phase 1 - MVP（最優先実装）

##### 3.1.1 音声認識機能
- [ ] マイク入力のリアルタイム認識
- [ ] ReazonSpeech-NeMo v2による日本語文字起こし
- [ ] 単一モデル使用（高速モデルを優先）
- [ ] 認識状態の管理（開始・停止・処理中）

##### 3.1.2 テキスト出力
- [ ] アクティブウィンドウへの直接入力（キーボードシミュレーション）
- [ ] 現在のカーソル位置に挿入
- [ ] 複数のテキスト入力フィールド対応（ブラウザ、エディタなど）

##### 3.1.3 UI/UX
- [ ] システムトレイ常駐
- [ ] ホットキーによる認識開始/停止（デフォルト: Ctrl+Shift+V）
- [ ] 認識状態のビジュアルフィードバック
  - アイコン変化（待機 → 認識中 → 停止）
  - 状態表示テキスト
- [ ] トレイメニュー（設定、終了）

##### 3.1.4 基本設定
- [ ] マイクデバイス選択
- [ ] ホットキーカスタマイズ（UI設定画面）
- [ ] 認識言語設定（日本語固定でも可）
- [ ] 設定の永続化（JSON/レジストリ）

#### Phase 2 - 拡張機能

##### 3.1.5 モデル切り替え
- [ ] 高速モデル ⇔ 高精度モデルの切り替え可能
- [ ] ユーザーによる手動切り替え（設定またはホットキー）
- [ ] モデル情報の表示

##### 3.1.6 フォーカス制御オプション
- [ ] オプション1: アクティブウィンドウ追従（デフォルト）
- [ ] オプション2: 認識開始時のウィンドウに固定
- [ ] 設定でON/OFF切り替え可能
- **特記**: 既存アプリの問題解決機能

##### 3.1.7 テキスト編集機能
- [ ] 認識中のテキストを一時保持（バッファ）
- [ ] アプリ内エディタで確認・修正後に出力
- [ ] 認識履歴の表示（直近10件程度）
- [ ] 履歴からのテキスト復活機能

#### Phase 3 - 高度な機能

##### 3.1.8 音声処理の最適化
- [ ] 音声の区切り検出（VAD: Voice Activity Detection）
- [ ] 句読点の自動挿入
- [ ] ノイズ除去・フィルタリング
- [ ] 入力レベル調整（ゲイン制御）

##### 3.1.9 辞書・カスタマイズ
- [ ] カスタム単語辞書
- [ ] ユーザー辞書インポート/エクスポート
- [ ] ドメイン別辞書（医学用語など）

##### 3.1.10 その他の高度な機能
- [ ] 認識結果の自動保存（CSV/JSON）
- [ ] 統計情報（認識時間、精度など）
- [ ] 複数マイク対応
- [ ] スピーカーフォンモード対応

### 3.2 非機能要件

#### 3.2.1 パフォーマンス
| 指標 | 目標値 |
|------|--------|
| 認識レイテンシ（高速モデル） | 500ms以内 |
| 認識レイテンシ（高精度モデル） | 2000ms以内 |
| メモリ使用量（アイドル） | 200MB以内 |
| メモリ使用量（認識中） | 1GB以内 |
| CPU使用率（アイドル） | 5%以内 |
| CPU使用率（認識中） | 70%以内 |
| 起動時間 | 3秒以内 |

#### 3.2.2 互換性
- Windows 10 21H2以降対応
- Windows 11対応
- .NET 8 LTS対応

#### 3.2.3 セキュリティ
- [ ] 音声データはローカルのみで処理
- [ ] ネットワーク通信なし（完全オフライン動作）
- [ ] ログデータの安全な保存
- [ ] 管理者権限が必要な機能の明示

#### 3.2.4 保守性
- [ ] 単体テスト実装（主要ロジック）
- [ ] CI/CD構築（GitHub Actions）
- [ ] コード品質チェック（StyleCop）
- [ ] ドキュメント整備

## 4. ディレクトリ構成

```
voice-scribe-win/
├── .github/
│   └── workflows/
│       └── build.yml              # CI/CD設定
├── src/
│   ├── VoiceScribe/               # WinUI 3 アプリケーション
│   │   ├── App.xaml
│   │   ├── App.xaml.cs
│   │   ├── Package.appxmanifest
│   │   ├── VoiceScribe.csproj
│   │   ├── Views/                 # UI (XAML)
│   │   │   ├── MainWindow.xaml
│   │   │   └── SettingsPage.xaml
│   │   ├── ViewModels/            # ViewModel (MVVM)
│   │   │   ├── MainViewModel.cs
│   │   │   └── SettingsViewModel.cs
│   │   ├── Models/                # データモデル
│   │   │   ├── RecognitionResult.cs
│   │   │   └── AppSettings.cs
│   │   ├── Services/              # ビジネスロジック
│   │   │   ├── ISpeechRecognitionService.cs
│   │   │   ├── ReazonSpeechService.cs
│   │   │   ├── AudioInputService.cs
│   │   │   ├── TextOutputService.cs
│   │   │   ├── HotkeyService.cs
│   │   │   └── SettingsService.cs
│   │   ├── Helpers/               # ユーティリティ
│   │   │   ├── WindowHelper.cs
│   │   │   └── AudioHelper.cs
│   │   └── Assets/                # 画像等
│   │
│   ├── VoiceScribe.Core/          # 共通ロジック（テスト可能）
│   │   ├── VoiceScribe.Core.csproj
│   │   ├── Models/
│   │   ├── Services/
│   │   └── Helpers/
│   │
│   └── VoiceScribe.Tests/         # 単体テスト
│       └── VoiceScribe.Tests.csproj
│
├── docs/
│   ├── requirements.md            # 要件定義書（このファイル）
│   ├── architecture.md            # アーキテクチャ設計書
│   ├── api-design.md              # API設計書
│   └── development-guide.md       # 開発ガイド
│
├── models/                        # 音声認識モデル配置先
│   └── .gitkeep
│
├── tests/                         # 機能テスト
│   └── .gitkeep
│
├── .gitignore
├── README.md
├── LICENSE
└── CHANGELOG.md
```

## 5. 実装計画（MVP Phase 1）

### Step 1: プロジェクト初期化
- [x] 要件定義書作成
- [ ] GitHub リポジトリ作成
- [ ] WinUI 3 プロジェクトテンプレート生成
- [ ] 依存関係インストール（NuGet）

### Step 2: 音声入力基盤
- [ ] AudioInputService実装（NAudio使用）
- [ ] マイク入力の取得・バッファリング
- [ ] 音声データのフォーマット変換（PCM 16-bit, 16kHz）
- [ ] 単体テスト作成

### Step 3: 音声認識統合
- [ ] ReazonSpeech-NeMo v2 の技術検証
- [ ] ONNX Runtime または Python interop検証
- [ ] ReazonSpeechService実装
- [ ] 認識結果のテキスト化

### Step 4: テキスト出力機能
- [ ] TextOutputService実装
- [ ] キーボード入力シミュレーション（Windows Input Simulator）
- [ ] アクティブウィンドウ検出
- [ ] カーソル位置への挿入

### Step 5: UI実装
- [ ] システムトレイアイコン（H.NotifyIcon.WinUI）
- [ ] ホットキー登録（HotkeyService）
- [ ] 設定画面（XAML）
  - マイク選択
  - ホットキー設定
- [ ] 認識状態の表示

### Step 6: 統合・テスト
- [ ] 各サービスの統合
- [ ] エンドツーエンドテスト
- [ ] パフォーマンステスト
- [ ] バグフィックス

## 6. 技術的課題と対応方針

### 課題 1: ReazonSpeech-NeMo v2 の .NET 統合

**問題**: Python ベースのモデルを C# .NET から呼び出す必要がある

**対応方針**:
1. **ONNX Runtime を使用**（推奨）
   - ReazonSpeech をONNX形式に変換
   - ONNX Runtime NuGet パッケージ利用
   - 利点: 完全.NET統合、高速推論
   - 課題: モデル変換作業

2. **Python interop（代替案）**
   - Python subprocess で ReazonSpeech を実行
   - JSON で音声とテキストをやり取り
   - 利点: 既存モデルがそのまま使用可能
   - 課題: Python 実行環境の配布

### 課題 2: キーボード入力シミュレーション

**問題**: セキュリティソフトによるブロック、管理者権限の要求

**対応方針**:
1. Windows Input Simulator ライブラリ使用
2. 低レベル Hook API（必要に応じて）
3. ユーザーへの事前説明（管理者権限が必要な場合）
4. 代替手段の検討（クリップボード経由など）

### 課題 3: パフォーマンス

**問題**: ローカル処理でリアルタイム性を実現

**対応方針**:
1. 音声バッファのサイズ最適化
2. 非同期処理（async/await）の活用
3. SIMD 処理（必要に応じて）
4. メモリ池パターンの実装

## 7. 検証方法

### 7.1 機能検証
1. ホットキー（Ctrl+Shift+V）で認識開始
2. マイクに向かって日本語で話す（「こんにちは、これはテストです」など）
3. アクティブなテキストボックスに文字が入力されることを確認
4. もう一度ホットキーで認識停止
5. 入力が止まることを確認

### 7.2 パフォーマンス検証
| 項目 | 確認方法 |
|------|---------|
| レイテンシ | ストップウォッチで測定（入力開始→出力完了） |
| メモリ | タスクマネージャーで確認 |
| CPU | タスクマネージャーで確認 |
| 安定性 | 長時間連続実行テスト（30分以上） |

### 7.3 エッジケース
- [ ] 異なるアプリケーション（Word, Excel, Chrome など）での動作確認
- [ ] 長時間認識の安定性（1時間連続など）
- [ ] マイクデバイス変更時の挙動
- [ ] 低スペック環境での動作確認
- [ ] ノイズの多い環境での認識精度

## 8. リスク・課題

| リスク | 影響度 | 対応策 |
|--------|--------|--------|
| ReazonSpeech 統合困難 | 高 | 早期 PoC 実装、代替モデル調査 |
| パフォーマンス不足 | 高 | 処理最適化、プロファイリング |
| キーボード入力ブロック | 中 | 管理者権限説明、代替手段検討 |
| Windows API の複雑さ | 中 | 既存ライブラリ活用、ドキュメント参考 |
| ユーザーサポート | 低 | FAQ、ドキュメント充実 |

## 9. 次のステップ

1. **GitHub リポジトリ作成**
   ```bash
   gh repo create voice-scribe-win --public
   ```

2. **WinUI 3 プロジェクト初期化**
   ```bash
   dotnet new winui -n VoiceScribe
   ```

3. **NuGet 依存関係インストール**
   - CommunityToolkit.Mvvm
   - NAudio
   - H.NotifyIcon.WinUI
   - ONNX Runtime (予定)

4. **ReazonSpeech-NeMo v2 の技術検証開始**

5. **Step 2: 音声入力基盤の実装開始**

---

**ドキュメント管理者**: Development Team
**最終更新**: 2026-02-02
